<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atomic Momentum</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #673ab7;
            color: white;
            padding: 16px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .app-header h1 {
            margin: 0;
        }
        .settings-icon {
            font-size: 24px;
            cursor: pointer;
        }
        .habit-card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .habit-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #673ab7;
        }
        .actions {
            display: flex;
            justify-content: space-evenly;
            margin-top: 8px;
        }
        button {
            border: none;
            background-color: transparent;
            color: #673ab7;
            cursor: pointer;
            font-size: 24px;
        }
        button:disabled {
            color: #bdbdbd;
            cursor: default;
        }
        .add-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background-color: #673ab7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="app-header">
        <h1>Momentum</h1>
        <div class="settings-icon" onclick="showSettingsScreen()">⚙️</div>
    </div>
    
    <div id="habits-container" style="padding: 0 10px;">
        <!-- Drink Water Habit -->
        <div class="habit-card">
            <div class="habit-title">
                <h2>Drink Water</h2>
                <span>5/8</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 62.5%"></div>
            </div>
            <div class="actions">
                <button onclick="updateProgress('water', -1)">-</button>
                <button onclick="updateProgress('water', 1)">+</button>
            </div>
        </div>
        
        <!-- Read Bible Habit -->
        <div class="habit-card">
            <div class="habit-title">
                <h2>Read Bible</h2>
                <span>3/7</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 42.8%"></div>
            </div>
            <div class="actions">
                <button onclick="updateProgress('bible', -1)">-</button>
                <button onclick="updateProgress('bible', 1)">+</button>
            </div>
        </div>
        
        <!-- Workout Habit -->
        <div class="habit-card">
            <div class="habit-title">
                <h2>Workout</h2>
                <span>7/7</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
            <div class="actions">
                <button onclick="updateProgress('workout', -1)" id="workout-minus">-</button>
                <button onclick="updateProgress('workout', 1)" id="workout-plus" disabled>+</button>
            </div>
        </div>
    </div>
    
    <div class="add-button" onclick="showAddHabitScreen()">+</div>

    <script>
        // Default habits to use if none are saved
        const defaultHabits = {
            water: { 
                progress: 5, 
                target: 8, 
                name: "Drink Water", 
                color: "#2196F3",
                lastUpdatedDate: new Date().toISOString(),
                resetFrequency: "weekly"
            },
            bible: { 
                progress: 3, 
                target: 7, 
                name: "Read Bible", 
                color: "#009688",
                lastUpdatedDate: new Date().toISOString(),
                resetFrequency: "weekly"
            },
            workout: { 
                progress: 7, 
                target: 7, 
                name: "Workout", 
                color: "#FF9800",
                lastUpdatedDate: new Date().toISOString(),
                resetFrequency: "weekly"
            }
        };
        
        // Our in-memory habits
        let habits = {};
        
        // Global theme management
        function isDarkModeEnabled() {
            return localStorage.getItem('isDarkMode') === 'true';
        }
        
        // Theme change listeners (for reactive updates)
        const themeListeners = [];
        
        function addThemeListener(callback) {
            themeListeners.push(callback);
        }
        
        function notifyThemeChange() {
            const isDark = isDarkModeEnabled();
            themeListeners.forEach(listener => listener(isDark));
        }
        
        // Load habits from localStorage
        function loadHabits() {
            const savedHabits = localStorage.getItem('atomic_momentum_habits');
            if (savedHabits) {
                try {
                    habits = JSON.parse(savedHabits);
                    console.log('Loaded habits from localStorage:', habits);
                    
                    // Check for habits that need to be reset based on their frequency
                    checkHabitResets();
                } catch (e) {
                    console.error('Error loading habits from localStorage:', e);
                    habits = {...defaultHabits};
                    saveHabits();
                }
            } else {
                // Use default habits if none are saved
                habits = {...defaultHabits};
                saveHabits();
            }
            
            // Update UI with loaded habits
            renderHabits();
            
            // Ensure theme is applied consistently after load
            applyTheme();
        }
        
        // Save habits to localStorage
        function saveHabits() {
            try {
                localStorage.setItem('atomic_momentum_habits', JSON.stringify(habits));
                console.log('Saved habits to localStorage');
            } catch (e) {
                console.error('Error saving habits to localStorage:', e);
            }
        }
        
        // Render all habits in the UI
        function renderHabits() {
            const container = document.getElementById('habits-container');
            container.innerHTML = ''; // Clear existing habits
            container.style.padding = '0 10px'; // Ensure padding applies to dynamically generated content
            
            // Get current theme state
            const isDarkMode = isDarkModeEnabled();
            
            Object.keys(habits).forEach(habitId => {
                const habit = habits[habitId];
                const habitElement = createHabitElement(habitId, habit);
                
                // Apply theme-specific styling to the card
                if (isDarkMode) {
                    habitElement.style.backgroundColor = '#1e1e1e';
                    // Find progress bar and set its background
                    const progressBar = habitElement.querySelector('.progress-bar');
                    if (progressBar) {
                        progressBar.style.backgroundColor = '#333';
                    }
                } else {
                    habitElement.style.backgroundColor = '#fff';
                    // Find progress bar and set its background
                    const progressBar = habitElement.querySelector('.progress-bar');
                    if (progressBar) {
                        progressBar.style.backgroundColor = '#e0e0e0';
                    }
                }
                
                container.appendChild(habitElement);
            });
        }
        
        // Create a habit card element
        function createHabitElement(habitId, habit) {
            const card = document.createElement('div');
            card.className = 'habit-card';
            // Add subtle shadow and increased spacing
            card.style.boxShadow = isDarkModeEnabled() ? '0 2px 8px rgba(255,255,255,0.05)' : '0 2px 8px rgba(0,0,0,0.1)';
            card.style.marginBottom = '15px'; // Increase vertical spacing between cards
            card.style.padding = '15px'; // Increase internal padding
            card.style.borderRadius = '10px'; // More rounded corners for a modern look
            
            const title = document.createElement('div');
            title.className = 'habit-title';
            title.style.display = 'flex';
            title.style.justifyContent = 'space-between';
            title.style.alignItems = 'center';
            
            const titleLeft = document.createElement('div');
            
            const heading = document.createElement('h2');
            // Check if habit has an icon and add it before the name
            if (habit.icon) {
                heading.textContent = `${habit.icon} ${habit.name}`;
            } else {
                heading.textContent = habit.name;
            }
            
            const progress = document.createElement('span');
            progress.textContent = `${habit.progress}/${habit.target}`;
            progress.style.color = habit.color;
            
            titleLeft.appendChild(heading);
            titleLeft.appendChild(progress);
            
            // Create button container for edit and delete
            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '5px';
            
            // Add edit button (pencil icon)
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '✏️'; // Pencil emoji
            editBtn.style.background = 'transparent';
            editBtn.style.border = 'none';
            editBtn.style.fontSize = '20px';
            editBtn.style.cursor = 'pointer';
            editBtn.style.padding = '0 5px';
            editBtn.title = 'Edit habit';
            editBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent any other event handlers
                showEditHabitScreen(habitId, habit);
            };
            
            // Add delete button (trash icon)
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '🗑️'; // Trash emoji
            deleteBtn.style.background = 'transparent';
            deleteBtn.style.border = 'none';
            deleteBtn.style.fontSize = '20px';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.padding = '0 5px';
            deleteBtn.title = 'Delete habit';
            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // Prevent any other event handlers
                
                // Show confirmation dialog
                if (confirm(`Are you sure you want to delete "${habit.name}"?`)) {
                    // Delete the habit
                    delete habits[habitId];
                    
                    // Save updated habits
                    saveHabits();
                    
                    // Re-render the UI
                    renderHabits();
                    
                    // Show feedback toast
                    const toast = document.createElement('div');
                    toast.textContent = 'Habit deleted!';
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.backgroundColor = '#f44336';
                    toast.style.color = 'white';
                    toast.style.padding = '10px 20px';
                    toast.style.borderRadius = '4px';
                    toast.style.zIndex = '1000';
                    toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    
                    document.body.appendChild(toast);
                    
                    // Animate toast
                    setTimeout(() => {
                        toast.style.opacity = '1';
                    }, 10);
                    
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            document.body.removeChild(toast);
                        }, 300);
                    }, 3000);
                }
            };
            
            btnContainer.appendChild(editBtn);
            btnContainer.appendChild(deleteBtn);
            
            title.appendChild(titleLeft);
            title.appendChild(btnContainer);
            
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            
            const progressFill = document.createElement('div');
            progressFill.className = 'progress-fill';
            progressFill.style.width = `${(habit.progress / habit.target) * 100}%`;
            progressFill.style.backgroundColor = habit.color;
            
            progressBar.appendChild(progressFill);
            
            const actions = document.createElement('div');
            actions.className = 'actions';
            
            const minusBtn = document.createElement('button');
            minusBtn.textContent = '-';
            minusBtn.style.color = habit.color;
            minusBtn.disabled = habit.progress <= 0;
            minusBtn.onclick = () => updateProgress(habitId, -1);
            
            const plusBtn = document.createElement('button');
            plusBtn.textContent = '+';
            plusBtn.style.color = habit.color;
            plusBtn.disabled = habit.progress >= habit.target;
            plusBtn.onclick = () => updateProgress(habitId, 1);
            
            actions.appendChild(minusBtn);
            actions.appendChild(plusBtn);
            
            card.appendChild(title);
            card.appendChild(progressBar);
            card.appendChild(actions);
            
            return card;
        }
        
        function updateProgress(habitId, change) {
            const habit = habits[habitId];
            const newProgress = habit.progress + change;
            
            if (newProgress >= 0 && newProgress <= habit.target) {
                // Store current theme state before any changes
                const currentIsDarkMode = isDarkModeEnabled();
                document.body.dataset.themeMode = currentIsDarkMode ? 'dark' : 'light'; // Additional backup
                
                habit.progress = newProgress;
                habit.lastUpdatedDate = new Date().toISOString(); // Update the last modified date
                
                // Save the updated state
                saveHabits();
                
                // Re-render all habits
                renderHabits();
                
                // Ensure theme is consistently applied after update
                if (currentIsDarkMode !== isDarkModeEnabled()) {
                    console.log('Theme state changed unexpectedly, fixing...');
                    localStorage.setItem('isDarkMode', String(currentIsDarkMode));
                } else if (document.body.dataset.themeMode === 'dark' && !isDarkModeEnabled()) {
                    console.log('Theme state changed based on dataset check, fixing...');
                    localStorage.setItem('isDarkMode', 'true');
                } else if (document.body.dataset.themeMode === 'light' && isDarkModeEnabled()) {
                    console.log('Theme state changed based on dataset check, fixing...');
                    localStorage.setItem('isDarkMode', 'false');
                }
                
                // Apply theme consistently
                applyTheme();
                
                // One more check after everything to ensure dark mode styling is applied
                const cards = document.querySelectorAll('.habit-card');
                if (currentIsDarkMode) {
                    cards.forEach(card => {
                        card.style.backgroundColor = '#1e1e1e';
                        const progressBar = card.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.backgroundColor = '#333';
                        }
                    });
                }
            }
        }
        
        // Check if habits need to be reset based on their frequency
        function checkHabitResets() {
            const currentDate = new Date();
            let hasChanges = false;
            
            // Process each habit
            Object.keys(habits).forEach(habitId => {
                const habit = habits[habitId];
                
                // Make sure habit has lastUpdatedDate (backward compatibility)
                if (!habit.lastUpdatedDate) {
                    habit.lastUpdatedDate = new Date().toISOString();
                    habit.resetFrequency = habit.resetFrequency || "weekly";
                    hasChanges = true;
                    return; // Skip this iteration
                }
                
                const lastUpdated = new Date(habit.lastUpdatedDate);
                
                switch (habit.resetFrequency || "weekly") {
                    case "daily":
                        // Reset if it's a different calendar day
                        if (currentDate.getDate() !== lastUpdated.getDate() ||
                            currentDate.getMonth() !== lastUpdated.getMonth() ||
                            currentDate.getFullYear() !== lastUpdated.getFullYear()) {
                            habit.progress = 0;
                            habit.lastUpdatedDate = currentDate.toISOString();
                            hasChanges = true;
                        }
                        break;
                        
                    case "weekly":
                        // Get ISO week numbers (1-52)
                        const getWeekNumber = (d) => {
                            // ISO week date weeks start on Monday, so correct the day number
                            const dayNum = d.getUTCDay() || 7;
                            
                            // Set the target date to the Thursday of this week
                            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate() + (4 - dayNum)));
                            
                            // Get first day of year
                            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                            
                            // Calculate full weeks to nearest Thursday
                            const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                            
                            return weekNum;
                        };
                        
                        const currentWeek = getWeekNumber(currentDate);
                        const lastWeek = getWeekNumber(lastUpdated);
                        const currentYear = currentDate.getFullYear();
                        const lastYear = lastUpdated.getFullYear();
                        
                        // Reset if the week number changed
                        if (currentWeek !== lastWeek || currentYear !== lastYear) {
                            habit.progress = 0;
                            habit.lastUpdatedDate = currentDate.toISOString();
                            hasChanges = true;
                        }
                        break;
                        
                    case "monthly":
                        // Reset if it's a different month
                        if (currentDate.getMonth() !== lastUpdated.getMonth() ||
                            currentDate.getFullYear() !== lastUpdated.getFullYear()) {
                            habit.progress = 0;
                            habit.lastUpdatedDate = currentDate.toISOString();
                            hasChanges = true;
                        }
                        break;
                }
            });
            
            // Save if changes were made
            if (hasChanges) {
                saveHabits();
                console.log('Habits were reset based on their reset frequency');
                
                // Apply theme consistently after habits are reset
                applyTheme();
            }
        }
        
        // Show Add Habit Screen (fullscreen)
        function showAddHabitScreen() {
            // Save current screen content
            const mainContent = document.body.innerHTML;
            
            // Get current theme
            const isDarkMode = isDarkModeEnabled();
            
            // Create full-screen form that simulates a navigation to a new screen
            document.body.innerHTML = '';
            
            // Create app elements
            const appScreen = document.createElement('div');
            appScreen.style.fontFamily = 'Arial, sans-serif';
            appScreen.style.maxWidth = '500px';
            appScreen.style.margin = '0 auto';
            appScreen.style.padding = '0';
            appScreen.style.backgroundColor = isDarkMode ? '#121212' : '#f5f5f5';
            appScreen.style.color = isDarkMode ? '#ffffff' : '#000000';
            appScreen.style.height = '100vh';
            appScreen.style.display = 'flex';
            appScreen.style.flexDirection = 'column';
            
            // Create AppBar
            const appBar = document.createElement('div');
            appBar.style.backgroundColor = '#673ab7';
            appBar.style.color = 'white';
            appBar.style.padding = '16px';
            appBar.style.display = 'flex';
            appBar.style.alignItems = 'center';
            
            // Back button
            const backButton = document.createElement('div');
            backButton.innerHTML = '&larr;';
            backButton.style.marginRight = '16px';
            backButton.style.fontSize = '24px';
            backButton.style.cursor = 'pointer';
            backButton.onclick = () => {
                // Return to the main screen
                document.body.innerHTML = mainContent;
                
                // Re-initialize event listeners and state
                document.addEventListener('DOMContentLoaded', loadHabits);
                loadHabits();
                
                // Ensure theme is applied correctly when returning to main screen
                applyTheme();
            };
            
            // Title
            const title = document.createElement('h1');
            title.textContent = 'Add New Habit';
            title.style.margin = '0';
            title.style.fontSize = '20px';
            
            appBar.appendChild(backButton);
            appBar.appendChild(title);
            
            // Create form container (scrollable)
            const formContainer = document.createElement('div');
            formContainer.style.flex = '1';
            formContainer.style.overflowY = 'auto';
            formContainer.style.padding = '20px';
            
            // Create form content
            const form = document.createElement('div');
            form.style.backgroundColor = isDarkMode ? '#1e1e1e' : 'white';
            form.style.padding = '20px';
            form.style.borderRadius = '8px';
            form.style.boxShadow = isDarkMode ? '0 1px 3px rgba(255,255,255,0.1)' : '0 1px 3px rgba(0,0,0,0.1)';
            
            const heading = document.createElement('h2');
            heading.textContent = 'Add New Habit';
            heading.style.textAlign = 'center';
            heading.style.marginBottom = '20px';
            
            // Emoji icon selector
            const iconLabel = document.createElement('div');
            iconLabel.textContent = 'Choose an Icon (Optional)';
            iconLabel.style.fontSize = '16px';
            iconLabel.style.fontWeight = 'bold';
            iconLabel.style.marginBottom = '10px';
            
            const emojiContainer = document.createElement('div');
            emojiContainer.style.display = 'flex';
            emojiContainer.style.flexWrap = 'wrap';
            emojiContainer.style.gap = '10px';
            emojiContainer.style.marginBottom = '20px';
            emojiContainer.style.justifyContent = 'center';
            
            // Popular emoji choices for habits
            const emojis = ['💧', '📚', '🏃', '🥗', '💪', '🧘', '💤', '💊', '🚫', '💻', '🎨', '🎵', '🌱', '🧹', '📝', '⏰', ''];
            let selectedEmoji = '';
            
            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('div');
                emojiBtn.textContent = emoji || 'None';
                emojiBtn.style.width = '42px';
                emojiBtn.style.height = '42px';
                emojiBtn.style.display = 'flex';
                emojiBtn.style.alignItems = 'center';
                emojiBtn.style.justifyContent = 'center';
                emojiBtn.style.fontSize = emoji ? '24px' : '12px';
                emojiBtn.style.cursor = 'pointer';
                emojiBtn.style.border = '1px solid #ccc';
                emojiBtn.style.borderRadius = '8px';
                emojiBtn.style.transition = 'all 0.3s ease';
                emojiBtn.style.backgroundColor = emoji === selectedEmoji ? '#e0e0e0' : (isDarkMode ? '#333' : '#fff');
                
                emojiBtn.onclick = () => {
                    selectedEmoji = emoji;
                    // Update all buttons to show selection
                    emojiContainer.querySelectorAll('div').forEach(btn => {
                        btn.style.backgroundColor = btn.textContent === (selectedEmoji || 'None') ? 
                            '#e0e0e0' : (isDarkMode ? '#333' : '#fff');
                        btn.style.transform = btn.textContent === (selectedEmoji || 'None') ? 
                            'scale(1.1)' : 'scale(1.0)';
                        btn.style.boxShadow = btn.textContent === (selectedEmoji || 'None') ? 
                            '0 2px 5px rgba(0,0,0,0.2)' : 'none';
                    });
                };
                
                emojiContainer.appendChild(emojiBtn);
            });
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Habit Name';
            nameInput.style.width = '100%';
            nameInput.style.padding = '16px';
            nameInput.style.fontSize = '16px';
            nameInput.style.marginBottom = '16px'; 
            nameInput.style.borderRadius = '8px';
            nameInput.style.border = '1px solid #ccc';
            nameInput.style.boxSizing = 'border-box';
            
            const targetInput = document.createElement('input');
            targetInput.type = 'number';
            targetInput.placeholder = 'Goal Number (weekly)';
            targetInput.min = '1';
            targetInput.max = '100';
            targetInput.style.width = '100%';
            targetInput.style.padding = '16px';
            targetInput.style.fontSize = '16px';
            targetInput.style.marginBottom = '24px';
            targetInput.style.borderRadius = '8px';
            targetInput.style.border = '1px solid #ccc';
            targetInput.style.boxSizing = 'border-box';
            
            const colorLabel = document.createElement('div');
            colorLabel.textContent = 'Habit Color';
            colorLabel.style.fontSize = '16px';
            colorLabel.style.fontWeight = 'bold';
            colorLabel.style.marginBottom = '10px';
            
            const colorsPicker = document.createElement('div');
            colorsPicker.style.display = 'flex';
            colorsPicker.style.justifyContent = 'center'; // Center the color picker
            colorsPicker.style.flexWrap = 'wrap'; // Allow wrapping to prevent horizontal scroll
            colorsPicker.style.marginBottom = '24px';
            colorsPicker.style.paddingBottom = '10px';
            
            const colors = ['#673ab7', '#2196F3', '#4CAF50', '#9C27B0', '#FF5722', '#009688', '#FF9800'];
            let selectedColor = colors[0];
            let createButton; // Reference to the save button that will be created later
            
            colors.forEach(color => {
                const colorBtn = document.createElement('div');
                colorBtn.style.width = '36px'; // Fixed width instead of minWidth
                colorBtn.style.height = '36px'; // Slightly smaller height
                colorBtn.style.backgroundColor = color;
                colorBtn.style.borderRadius = '50%';
                colorBtn.style.cursor = 'pointer';
                colorBtn.style.margin = '8px'; // Add margin on all sides for even spacing
                colorBtn.style.transition = 'all 0.3s ease';
                colorBtn.style.boxSizing = 'border-box';
                colorBtn.style.display = 'flex';
                colorBtn.style.alignItems = 'center';
                colorBtn.style.justifyContent = 'center';
                
                if (color === selectedColor) {
                    colorBtn.style.transform = 'scale(1.1)';
                    colorBtn.style.border = '3px solid black';
                    colorBtn.style.boxShadow = `0 4px 8px ${color}80`;
                    
                    // Add check icon
                    const checkIcon = document.createElement('div');
                    checkIcon.innerHTML = '✓';
                    checkIcon.style.color = 'white';
                    checkIcon.style.fontSize = '18px';
                    colorBtn.appendChild(checkIcon);
                } else {
                    colorBtn.style.border = '1px solid rgba(0,0,0,0.1)';
                }
                
                colorBtn.onclick = () => {
                    selectedColor = color;
                    document.querySelectorAll('#color-picker > div').forEach(btn => {
                        btn.style.transform = 'scale(1.0)';
                        btn.style.border = '1px solid rgba(0,0,0,0.1)';
                        btn.style.boxShadow = 'none';
                        btn.innerHTML = '';
                    });
                    
                    colorBtn.style.transform = 'scale(1.1)';
                    colorBtn.style.border = '3px solid black';
                    colorBtn.style.boxShadow = `0 4px 8px ${color}80`;
                    createButton.style.backgroundColor = color;
                    
                    // Add check icon
                    const checkIcon = document.createElement('div');
                    checkIcon.innerHTML = '✓';
                    checkIcon.style.color = 'white';
                    checkIcon.style.fontSize = '18px';
                    colorBtn.appendChild(checkIcon);
                };
                
                colorsPicker.appendChild(colorBtn);
            });
            colorsPicker.id = 'color-picker';
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.justifyContent = 'space-between';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.padding = '10px 20px';
            cancelBtn.style.border = 'none';
            cancelBtn.style.borderRadius = '4px';
            cancelBtn.style.backgroundColor = '#f5f5f5';
            cancelBtn.style.cursor = 'pointer';
            
            cancelBtn.onclick = () => {
                // Return to the main screen
                document.body.innerHTML = mainContent;
                
                // Re-initialize event listeners and state
                document.addEventListener('DOMContentLoaded', loadHabits);
                loadHabits();
                
                // Ensure theme is applied correctly when returning to main screen
                applyTheme();
            };
            
            form.appendChild(heading);
            form.appendChild(iconLabel);
            form.appendChild(emojiContainer);
            form.appendChild(nameInput);
            form.appendChild(targetInput);
            form.appendChild(colorLabel);
            form.appendChild(colorsPicker);
            
            formContainer.appendChild(form);
            
            // Save button (large bottom button)
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.style.padding = '16px';
            saveButtonContainer.style.backgroundColor = isDarkMode ? '#1e1e1e' : 'white';
            saveButtonContainer.style.boxShadow = isDarkMode ? '0 -1px 3px rgba(255,255,255,0.1)' : '0 -1px 3px rgba(0,0,0,0.1)';
            
            createButton = document.createElement('button');
            createButton.textContent = 'Create Habit';
            createButton.style.width = '100%';
            createButton.style.padding = '18px';
            createButton.style.backgroundColor = selectedColor;
            createButton.style.color = 'white';
            createButton.style.border = 'none';
            createButton.style.borderRadius = '16px';
            createButton.style.fontSize = '18px';
            createButton.style.fontWeight = 'bold';
            createButton.style.cursor = 'pointer';
            createButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            createButton.style.transition = 'transform 0.2s, box-shadow 0.2s';
            
            createButton.onmouseover = () => {
                createButton.style.transform = 'translateY(-2px)';
                createButton.style.boxShadow = '0 8px 12px rgba(0,0,0,0.25)';
            };
            
            createButton.onmouseout = () => {
                createButton.style.transform = 'translateY(0)';
                createButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            };
            
            createButton.onclick = () => {
                if (nameInput.value.trim() && targetInput.value.trim()) {
                    const habitId = 'habit_' + Date.now();
                    habits[habitId] = {
                        name: nameInput.value.trim(),
                        target: parseInt(targetInput.value, 10),
                        progress: 0,
                        color: selectedColor,
                        icon: selectedEmoji, // Add the selected emoji
                        lastUpdatedDate: new Date().toISOString(),
                        resetFrequency: "weekly" // Default to weekly reset
                    };
                    
                    saveHabits();
                    
                    // Return to main screen
                    document.body.innerHTML = mainContent;
                    
                    // Re-initialize event listeners
                    document.addEventListener('DOMContentLoaded', loadHabits);
                    loadHabits();
                    
                    // Ensure theme is applied correctly when returning to main screen
                    applyTheme();
                } else {
                    alert('Please fill out all fields');
                }
            };
            
            saveButtonContainer.appendChild(createButton);
            
            // Assemble the screen
            appScreen.appendChild(appBar);
            appScreen.appendChild(formContainer);
            appScreen.appendChild(saveButtonContainer);
            
            document.body.appendChild(appScreen);
            
            // Focus the first input for better UX
            nameInput.focus();
        }
        
        // Settings screen with dark mode toggle
        function showSettingsScreen() {
            // Save current screen content
            const mainContent = document.body.innerHTML;
            
            // Load current theme setting
            const isDarkMode = isDarkModeEnabled();
            
            // Create full-screen settings page
            document.body.innerHTML = '';
            
            // Create app elements
            const appScreen = document.createElement('div');
            appScreen.style.fontFamily = 'Arial, sans-serif';
            appScreen.style.maxWidth = '500px';
            appScreen.style.margin = '0 auto';
            appScreen.style.padding = '0';
            appScreen.style.backgroundColor = isDarkMode ? '#121212' : '#f5f5f5';
            appScreen.style.color = isDarkMode ? '#ffffff' : '#000000';
            appScreen.style.height = '100vh';
            appScreen.style.display = 'flex';
            appScreen.style.flexDirection = 'column';
            
            // Create AppBar
            const appBar = document.createElement('div');
            appBar.style.backgroundColor = '#673ab7';
            appBar.style.color = 'white';
            appBar.style.padding = '16px';
            appBar.style.display = 'flex';
            appBar.style.alignItems = 'center';
            
            // Back button
            const backButton = document.createElement('div');
            backButton.innerHTML = '&larr;';
            backButton.style.marginRight = '16px';
            backButton.style.fontSize = '24px';
            backButton.style.cursor = 'pointer';
            backButton.onclick = () => {
                // Return to the main screen
                document.body.innerHTML = mainContent;
                
                // Re-initialize event listeners and state
                document.addEventListener('DOMContentLoaded', loadHabits);
                loadHabits();
                
                // Apply theme if it was changed
                applyTheme();
            };
            
            // Title
            const title = document.createElement('h1');
            title.textContent = 'Settings';
            title.style.margin = '0';
            title.style.fontSize = '20px';
            
            appBar.appendChild(backButton);
            appBar.appendChild(title);
            
            // Create settings container
            const settingsContainer = document.createElement('div');
            settingsContainer.style.flex = '1';
            settingsContainer.style.overflowY = 'auto';
            settingsContainer.style.padding = '20px';
            
            // Settings section: Appearance
            const appearanceSection = document.createElement('div');
            appearanceSection.style.backgroundColor = isDarkMode ? '#1e1e1e' : 'white';
            appearanceSection.style.padding = '16px';
            appearanceSection.style.borderRadius = '8px';
            appearanceSection.style.boxShadow = isDarkMode ? '0 1px 3px rgba(255,255,255,0.1)' : '0 1px 3px rgba(0,0,0,0.1)';
            appearanceSection.style.marginBottom = '16px';
            
            const appearanceTitle = document.createElement('h3');
            appearanceTitle.textContent = 'Appearance';
            appearanceTitle.style.margin = '0 0 16px 0';
            
            // Dark Mode Switch
            const darkModeRow = document.createElement('div');
            darkModeRow.style.display = 'flex';
            darkModeRow.style.alignItems = 'center';
            darkModeRow.style.justifyContent = 'space-between';
            darkModeRow.style.padding = '8px 0';
            
            const darkModeLabel = document.createElement('div');
            
            const darkModeLabelTitle = document.createElement('div');
            darkModeLabelTitle.textContent = 'Dark Mode';
            darkModeLabelTitle.style.fontWeight = 'bold';
            
            const darkModeLabelDesc = document.createElement('div');
            darkModeLabelDesc.textContent = 'Switch between light and dark themes';
            darkModeLabelDesc.style.fontSize = '14px';
            darkModeLabelDesc.style.color = '#757575';
            darkModeLabelDesc.style.marginTop = '4px';
            
            darkModeLabel.appendChild(darkModeLabelTitle);
            darkModeLabel.appendChild(darkModeLabelDesc);
            
            // Switch component
            const switchContainer = document.createElement('label');
            switchContainer.style.position = 'relative';
            switchContainer.style.display = 'inline-block';
            switchContainer.style.width = '60px';
            switchContainer.style.height = '34px';
            
            const switchInput = document.createElement('input');
            switchInput.type = 'checkbox';
            switchInput.checked = isDarkMode;
            switchInput.style.opacity = '0';
            switchInput.style.width = '0';
            switchInput.style.height = '0';
            
            const switchSlider = document.createElement('span');
            switchSlider.style.position = 'absolute';
            switchSlider.style.cursor = 'pointer';
            switchSlider.style.top = '0';
            switchSlider.style.left = '0';
            switchSlider.style.right = '0';
            switchSlider.style.bottom = '0';
            switchSlider.style.backgroundColor = isDarkMode ? '#673ab7' : '#ccc';
            switchSlider.style.borderRadius = '34px';
            switchSlider.style.transition = '.4s';
            
            // Slider button
            const sliderButton = document.createElement('span');
            sliderButton.style.position = 'absolute';
            sliderButton.style.content = '""';
            sliderButton.style.height = '26px';
            sliderButton.style.width = '26px';
            sliderButton.style.left = isDarkMode ? '30px' : '4px';
            sliderButton.style.bottom = '4px';
            sliderButton.style.backgroundColor = 'white';
            sliderButton.style.borderRadius = '50%';
            sliderButton.style.transition = '.4s';
            
            switchSlider.appendChild(sliderButton);
            switchContainer.appendChild(switchInput);
            switchContainer.appendChild(switchSlider);
            
            // Toggle dark mode
            switchInput.onchange = (e) => {
                const checked = e.target.checked;
                switchSlider.style.backgroundColor = checked ? '#673ab7' : '#ccc';
                sliderButton.style.left = checked ? '30px' : '4px';
                
                // Save the theme preference
                localStorage.setItem('isDarkMode', checked);
                
                // Apply theme immediately to settings screen
                appScreen.style.backgroundColor = checked ? '#121212' : '#f5f5f5';
                appScreen.style.color = checked ? '#fff' : '#000';
                appearanceSection.style.backgroundColor = checked ? '#1e1e1e' : '#ffffff';
                darkModeLabelDesc.style.color = checked ? '#aaa' : '#757575';
                developerSection.style.backgroundColor = checked ? '#1e1e1e' : '#ffffff';
                
                // Notify all theme listeners
                notifyThemeChange();
            };
            
            darkModeRow.appendChild(darkModeLabel);
            darkModeRow.appendChild(switchContainer);
            
            appearanceSection.appendChild(appearanceTitle);
            appearanceSection.appendChild(darkModeRow);
            
            // Add all sections to the settings container
            settingsContainer.appendChild(appearanceSection);
            
            // Developer Testing Section
            const developerSection = document.createElement('div');
            developerSection.style.backgroundColor = isDarkMode ? '#1e1e1e' : 'white';
            developerSection.style.padding = '16px';
            developerSection.style.borderRadius = '8px';
            developerSection.style.boxShadow = isDarkMode ? '0 1px 3px rgba(255,255,255,0.1)' : '0 1px 3px rgba(0,0,0,0.1)';
            developerSection.style.marginBottom = '16px';
            
            const developerTitle = document.createElement('h3');
            developerTitle.textContent = 'Developer Testing';
            developerTitle.style.margin = '0 0 16px 0';
            
            // Developer note
            const developerNote = document.createElement('div');
            developerNote.textContent = '⚠️ For testing only - Will be removed before production';
            developerNote.style.fontSize = '12px';
            developerNote.style.color = isDarkMode ? '#ff9800' : '#e65100';
            developerNote.style.marginBottom = '12px';
            developerNote.style.fontWeight = 'bold';
            
            // Reset Test Button Row
            const resetTestRow = document.createElement('div');
            resetTestRow.style.display = 'flex';
            resetTestRow.style.alignItems = 'center';
            resetTestRow.style.justifyContent = 'space-between';
            resetTestRow.style.padding = '8px 0';
            
            const resetTestLabel = document.createElement('div');
            
            const resetTestTitle = document.createElement('div');
            resetTestTitle.textContent = 'Force Reset Progress';
            resetTestTitle.style.fontWeight = 'bold';
            
            const resetTestDesc = document.createElement('div');
            resetTestDesc.textContent = 'Test habit reset without waiting for time boundaries';
            resetTestDesc.style.fontSize = '14px';
            resetTestDesc.style.color = isDarkMode ? '#aaa' : '#757575';
            resetTestDesc.style.marginTop = '4px';
            
            resetTestLabel.appendChild(resetTestTitle);
            resetTestLabel.appendChild(resetTestDesc);
            
            // Reset button
            const resetButton = document.createElement('button');
            resetButton.textContent = 'Reset All';
            resetButton.style.padding = '8px 16px';
            resetButton.style.backgroundColor = '#f44336';
            resetButton.style.color = 'white';
            resetButton.style.border = 'none';
            resetButton.style.borderRadius = '4px';
            resetButton.style.cursor = 'pointer';
            resetButton.style.fontWeight = 'bold';
            resetButton.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
            
            // Reset button hover effect
            resetButton.onmouseover = () => {
                resetButton.style.backgroundColor = '#d32f2f';
            };
            
            resetButton.onmouseout = () => {
                resetButton.style.backgroundColor = '#f44336';
            };
            
            // Implement reset functionality
            resetButton.onclick = () => {
                // Force reset all habit progress
                Object.keys(habits).forEach(habitId => {
                    const habit = habits[habitId];
                    habit.progress = 0;
                    habit.lastUpdatedDate = new Date().toISOString();
                });
                
                // Save changes
                saveHabits();
                
                // Show feedback toast
                const toast = document.createElement('div');
                toast.textContent = 'Habit progress reset!';
                toast.style.position = 'fixed';
                toast.style.bottom = '20px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.backgroundColor = '#333';
                toast.style.color = 'white';
                toast.style.padding = '10px 20px';
                toast.style.borderRadius = '4px';
                toast.style.zIndex = '1000';
                toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                
                document.body.appendChild(toast);
                
                // Animate toast
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            };
            
            resetTestRow.appendChild(resetTestLabel);
            resetTestRow.appendChild(resetButton);
            
            developerSection.appendChild(developerTitle);
            developerSection.appendChild(developerNote);
            developerSection.appendChild(resetTestRow);
            
            // Add developer section to the settings container
            settingsContainer.appendChild(developerSection);
            
            // Assemble the screen
            appScreen.appendChild(appBar);
            appScreen.appendChild(settingsContainer);
            
            document.body.appendChild(appScreen);
            
            // Apply current theme to settings screen consistently
            if (isDarkMode) {
                appScreen.style.backgroundColor = '#121212';
                appScreen.style.color = '#fff';
                appearanceSection.style.backgroundColor = '#1e1e1e';
                darkModeLabelDesc.style.color = '#aaa';
                developerSection.style.backgroundColor = '#1e1e1e';
                resetTestDesc.style.color = '#aaa';
                developerNote.style.color = '#ff9800';
            } else {
                appScreen.style.backgroundColor = '#f5f5f5';
                appScreen.style.color = '#000';
                appearanceSection.style.backgroundColor = '#ffffff';
                darkModeLabelDesc.style.color = '#757575';
                developerSection.style.backgroundColor = '#ffffff';
                resetTestDesc.style.color = '#757575';
                developerNote.style.color = '#e65100';
            }
        }
        
        // Apply theme based on saved preference
        function applyTheme() {
            const isDarkMode = isDarkModeEnabled();
            
            if (isDarkMode) {
                document.body.style.backgroundColor = '#121212';
                document.body.style.color = '#fff';
                document.body.dataset.themeMode = 'dark'; // Set data attribute for tracking
                
                // Update card backgrounds
                const cards = document.querySelectorAll('.habit-card');
                cards.forEach(card => {
                    card.style.backgroundColor = '#1e1e1e';
                });
                
                // Update progress bars
                const progressBars = document.querySelectorAll('.progress-bar');
                progressBars.forEach(bar => {
                    bar.style.backgroundColor = '#333';
                });
            } else {
                document.body.style.backgroundColor = '#f5f5f5';
                document.body.style.color = '#000';
                document.body.dataset.themeMode = 'light'; // Set data attribute for tracking
                
                // Update card backgrounds
                const cards = document.querySelectorAll('.habit-card');
                cards.forEach(card => {
                    card.style.backgroundColor = '#fff';
                });
                
                // Update progress bars
                const progressBars = document.querySelectorAll('.progress-bar');
                progressBars.forEach(bar => {
                    bar.style.backgroundColor = '#e0e0e0';
                });
            }
            
            // Force styling update on all habit cards to ensure theme is applied
            setTimeout(() => {
                const isDark = isDarkModeEnabled();
                const cards = document.querySelectorAll('.habit-card');
                
                cards.forEach(card => {
                    card.style.backgroundColor = isDark ? '#1e1e1e' : '#fff';
                    const bar = card.querySelector('.progress-bar');
                    if (bar) {
                        bar.style.backgroundColor = isDark ? '#333' : '#e0e0e0';
                    }
                });
            }, 10);
            
            // Notify all registered theme listeners
            notifyThemeChange();
        }
        
        // Show Edit Habit Screen (fullscreen)
        function showEditHabitScreen(habitId, habit) {
            // Save current screen content
            const mainContent = document.body.innerHTML;
            
            // Get current theme
            const isDarkMode = isDarkModeEnabled();
            
            // Create full-screen form that simulates a navigation to a new screen
            document.body.innerHTML = '';
            
            // Create app elements
            const appScreen = document.createElement('div');
            appScreen.style.fontFamily = 'Arial, sans-serif';
            appScreen.style.maxWidth = '500px';
            appScreen.style.margin = '0 auto';
            appScreen.style.padding = '0';
            appScreen.style.backgroundColor = isDarkMode ? '#121212' : '#f5f5f5';
            appScreen.style.color = isDarkMode ? '#ffffff' : '#000000';
            appScreen.style.height = '100vh';
            appScreen.style.display = 'flex';
            appScreen.style.flexDirection = 'column';
            
            // Create AppBar
            const appBar = document.createElement('div');
            appBar.style.backgroundColor = '#673ab7';
            appBar.style.color = 'white';
            appBar.style.padding = '16px';
            appBar.style.display = 'flex';
            appBar.style.alignItems = 'center';
            
            // Back button
            const backButton = document.createElement('div');
            backButton.innerHTML = '&larr;';
            backButton.style.marginRight = '16px';
            backButton.style.fontSize = '24px';
            backButton.style.cursor = 'pointer';
            backButton.onclick = () => {
                // Return to the main screen
                document.body.innerHTML = mainContent;
                
                // Re-initialize event listeners and state
                document.addEventListener('DOMContentLoaded', loadHabits);
                loadHabits();
                
                // Ensure theme is applied correctly when returning to main screen
                applyTheme();
            };
            
            // Title
            const title = document.createElement('h1');
            title.textContent = 'Edit Habit';
            title.style.margin = '0';
            title.style.fontSize = '20px';
            
            appBar.appendChild(backButton);
            appBar.appendChild(title);
            
            // Create form container (scrollable)
            const formContainer = document.createElement('div');
            formContainer.style.flex = '1';
            formContainer.style.overflowY = 'auto';
            formContainer.style.padding = '20px';
            
            // Create form content
            const form = document.createElement('div');
            form.style.backgroundColor = isDarkMode ? '#1e1e1e' : 'white';
            form.style.padding = '20px';
            form.style.borderRadius = '8px';
            form.style.boxShadow = isDarkMode ? '0 1px 3px rgba(255,255,255,0.1)' : '0 1px 3px rgba(0,0,0,0.1)';
            
            const heading = document.createElement('h2');
            heading.textContent = 'Edit Habit';
            heading.style.textAlign = 'center';
            heading.style.marginBottom = '20px';
            
            // Emoji icon selector
            const iconLabel = document.createElement('div');
            iconLabel.textContent = 'Choose an Icon (Optional)';
            iconLabel.style.fontSize = '16px';
            iconLabel.style.fontWeight = 'bold';
            iconLabel.style.marginBottom = '10px';
            
            const emojiContainer = document.createElement('div');
            emojiContainer.style.display = 'flex';
            emojiContainer.style.flexWrap = 'wrap';
            emojiContainer.style.gap = '10px';
            emojiContainer.style.marginBottom = '20px';
            emojiContainer.style.justifyContent = 'center';
            
            // Popular emoji choices for habits
            const emojis = ['💧', '📚', '🏃', '🥗', '💪', '🧘', '💤', '💊', '🚫', '💻', '🎨', '🎵', '🌱', '🧹', '📝', '⏰', ''];
            let selectedEmoji = habit.icon || ''; // Pre-select current icon if exists
            
            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('div');
                emojiBtn.textContent = emoji || 'None';
                emojiBtn.style.width = '42px';
                emojiBtn.style.height = '42px';
                emojiBtn.style.display = 'flex';
                emojiBtn.style.alignItems = 'center';
                emojiBtn.style.justifyContent = 'center';
                emojiBtn.style.fontSize = emoji ? '24px' : '12px';
                emojiBtn.style.cursor = 'pointer';
                emojiBtn.style.border = '1px solid #ccc';
                emojiBtn.style.borderRadius = '8px';
                emojiBtn.style.transition = 'all 0.3s ease';
                emojiBtn.style.backgroundColor = emoji === selectedEmoji ? '#e0e0e0' : (isDarkMode ? '#333' : '#fff');
                emojiBtn.style.transform = emoji === selectedEmoji ? 'scale(1.1)' : 'scale(1.0)';
                emojiBtn.style.boxShadow = emoji === selectedEmoji ? '0 2px 5px rgba(0,0,0,0.2)' : 'none';
                
                emojiBtn.onclick = () => {
                    selectedEmoji = emoji;
                    // Update all buttons to show selection
                    emojiContainer.querySelectorAll('div').forEach(btn => {
                        btn.style.backgroundColor = btn.textContent === (selectedEmoji || 'None') ? 
                            '#e0e0e0' : (isDarkMode ? '#333' : '#fff');
                        btn.style.transform = btn.textContent === (selectedEmoji || 'None') ? 
                            'scale(1.1)' : 'scale(1.0)';
                        btn.style.boxShadow = btn.textContent === (selectedEmoji || 'None') ? 
                            '0 2px 5px rgba(0,0,0,0.2)' : 'none';
                    });
                };
                
                emojiContainer.appendChild(emojiBtn);
            });
            
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = 'Habit Name';
            nameInput.style.width = '100%';
            nameInput.style.padding = '16px';
            nameInput.style.fontSize = '16px';
            nameInput.style.marginBottom = '16px'; 
            nameInput.style.borderRadius = '8px';
            nameInput.style.border = '1px solid #ccc';
            nameInput.style.boxSizing = 'border-box';
            nameInput.value = habit.name; // Pre-fill with habit name
            
            const targetInput = document.createElement('input');
            targetInput.type = 'number';
            targetInput.placeholder = 'Goal Number (weekly)';
            targetInput.min = '1';
            targetInput.max = '100';
            targetInput.style.width = '100%';
            targetInput.style.padding = '16px';
            targetInput.style.fontSize = '16px';
            targetInput.style.marginBottom = '24px';
            targetInput.style.borderRadius = '8px';
            targetInput.style.border = '1px solid #ccc';
            targetInput.style.boxSizing = 'border-box';
            targetInput.value = habit.target; // Pre-fill with habit target
            
            const colorLabel = document.createElement('div');
            colorLabel.textContent = 'Habit Color';
            colorLabel.style.fontSize = '16px';
            colorLabel.style.fontWeight = 'bold';
            colorLabel.style.marginBottom = '10px';
            
            const colorsPicker = document.createElement('div');
            colorsPicker.style.display = 'flex';
            colorsPicker.style.justifyContent = 'center'; // Center the color picker
            colorsPicker.style.flexWrap = 'wrap'; // Allow wrapping to prevent horizontal scroll
            colorsPicker.style.marginBottom = '24px';
            colorsPicker.style.paddingBottom = '10px';
            
            const colors = ['#673ab7', '#2196F3', '#4CAF50', '#9C27B0', '#FF5722', '#009688', '#FF9800'];
            let selectedColor = habit.color; // Pre-select current habit color
            let saveButton; // Reference to the save button that will be created later
            
            colors.forEach(color => {
                const colorBtn = document.createElement('div');
                colorBtn.style.width = '36px'; // Fixed width instead of minWidth
                colorBtn.style.height = '36px'; // Slightly smaller height
                colorBtn.style.backgroundColor = color;
                colorBtn.style.borderRadius = '50%';
                colorBtn.style.cursor = 'pointer';
                colorBtn.style.margin = '8px'; // Add margin on all sides for even spacing
                colorBtn.style.transition = 'all 0.3s ease';
                colorBtn.style.boxSizing = 'border-box';
                colorBtn.style.display = 'flex';
                colorBtn.style.alignItems = 'center';
                colorBtn.style.justifyContent = 'center';
                
                if (color === selectedColor) {
                    colorBtn.style.transform = 'scale(1.1)';
                    colorBtn.style.border = '3px solid black';
                    colorBtn.style.boxShadow = `0 4px 8px ${color}80`;
                    
                    // Add check icon
                    const checkIcon = document.createElement('div');
                    checkIcon.innerHTML = '✓';
                    checkIcon.style.color = 'white';
                    checkIcon.style.fontSize = '18px';
                    colorBtn.appendChild(checkIcon);
                } else {
                    colorBtn.style.border = '1px solid rgba(0,0,0,0.1)';
                }
                
                colorBtn.onclick = () => {
                    selectedColor = color;
                    document.querySelectorAll('#color-picker > div').forEach(btn => {
                        btn.style.transform = 'scale(1.0)';
                        btn.style.border = '1px solid rgba(0,0,0,0.1)';
                        btn.style.boxShadow = 'none';
                        btn.innerHTML = '';
                    });
                    
                    colorBtn.style.transform = 'scale(1.1)';
                    colorBtn.style.border = '3px solid black';
                    colorBtn.style.boxShadow = `0 4px 8px ${color}80`;
                    saveButton.style.backgroundColor = color;
                    
                    // Add check icon
                    const checkIcon = document.createElement('div');
                    checkIcon.innerHTML = '✓';
                    checkIcon.style.color = 'white';
                    checkIcon.style.fontSize = '18px';
                    colorBtn.appendChild(checkIcon);
                };
                
                colorsPicker.appendChild(colorBtn);
            });
            colorsPicker.id = 'color-picker';
            
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.justifyContent = 'space-between';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.padding = '10px 20px';
            cancelBtn.style.border = 'none';
            cancelBtn.style.borderRadius = '4px';
            cancelBtn.style.backgroundColor = '#f5f5f5';
            cancelBtn.style.cursor = 'pointer';
            
            cancelBtn.onclick = () => {
                // Return to the main screen
                document.body.innerHTML = mainContent;
                
                // Re-initialize event listeners and state
                document.addEventListener('DOMContentLoaded', loadHabits);
                loadHabits();
                
                // Ensure theme is applied correctly when returning to main screen
                applyTheme();
            };
            
            form.appendChild(heading);
            form.appendChild(iconLabel);
            form.appendChild(emojiContainer);
            form.appendChild(nameInput);
            form.appendChild(targetInput);
            form.appendChild(colorLabel);
            form.appendChild(colorsPicker);
            
            formContainer.appendChild(form);
            
            // Save button (large bottom button)
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.style.padding = '16px';
            saveButtonContainer.style.backgroundColor = isDarkMode ? '#1e1e1e' : 'white';
            saveButtonContainer.style.boxShadow = isDarkMode ? '0 -1px 3px rgba(255,255,255,0.1)' : '0 -1px 3px rgba(0,0,0,0.1)';
            
            // Create a container for buttons (Save and Cancel side by side)
            const buttonRow = document.createElement('div');
            buttonRow.style.display = 'flex';
            buttonRow.style.gap = '10px';
            buttonRow.style.width = '100%';
            
            // Cancel button
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.style.flex = '1';
            cancelButton.style.padding = '18px';
            cancelButton.style.backgroundColor = '#9e9e9e';
            cancelButton.style.color = 'white';
            cancelButton.style.border = 'none';
            cancelButton.style.borderRadius = '16px';
            cancelButton.style.fontSize = '18px';
            cancelButton.style.fontWeight = 'bold';
            cancelButton.style.cursor = 'pointer';
            cancelButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            cancelButton.style.transition = 'transform 0.2s, box-shadow 0.2s';
            
            cancelButton.onmouseover = () => {
                cancelButton.style.transform = 'translateY(-2px)';
                cancelButton.style.boxShadow = '0 8px 12px rgba(0,0,0,0.25)';
            };
            
            cancelButton.onmouseout = () => {
                cancelButton.style.transform = 'translateY(0)';
                cancelButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            };
            
            cancelButton.onclick = () => {
                // Return to main screen without saving
                document.body.innerHTML = mainContent;
                
                // Re-initialize event listeners
                document.addEventListener('DOMContentLoaded', loadHabits);
                loadHabits();
                
                // Ensure theme is applied correctly when returning to main screen
                applyTheme();
            };
            
            // Save button
            saveButton = document.createElement('button');
            saveButton.textContent = 'Save Changes';
            saveButton.style.flex = '2';
            saveButton.style.padding = '18px';
            saveButton.style.backgroundColor = selectedColor;
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.borderRadius = '16px';
            saveButton.style.fontSize = '18px';
            saveButton.style.fontWeight = 'bold';
            saveButton.style.cursor = 'pointer';
            saveButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            saveButton.style.transition = 'transform 0.2s, box-shadow 0.2s';
            
            saveButton.onmouseover = () => {
                saveButton.style.transform = 'translateY(-2px)';
                saveButton.style.boxShadow = '0 8px 12px rgba(0,0,0,0.25)';
            };
            
            saveButton.onmouseout = () => {
                saveButton.style.transform = 'translateY(0)';
                saveButton.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            };
            
            saveButton.onclick = () => {
                if (nameInput.value.trim() && targetInput.value.trim()) {
                    // Preserve existing progress, lastUpdatedDate and resetFrequency
                    habits[habitId] = {
                        ...habits[habitId], // Keep existing properties
                        name: nameInput.value.trim(),
                        target: parseInt(targetInput.value, 10),
                        color: selectedColor,
                        icon: selectedEmoji // Save the selected emoji
                    };
                    
                    saveHabits();
                    
                    // Show feedback toast
                    const toast = document.createElement('div');
                    toast.textContent = 'Habit updated!';
                    toast.style.position = 'fixed';
                    toast.style.bottom = '20px';
                    toast.style.left = '50%';
                    toast.style.transform = 'translateX(-50%)';
                    toast.style.backgroundColor = '#4caf50';
                    toast.style.color = 'white';
                    toast.style.padding = '10px 20px';
                    toast.style.borderRadius = '4px';
                    toast.style.zIndex = '1000';
                    toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    
                    document.body.appendChild(toast);
                    
                    // Animate toast
                    setTimeout(() => {
                        toast.style.opacity = '1';
                    }, 10);
                    
                    setTimeout(() => {
                        // Return to main screen
                        document.body.innerHTML = mainContent;
                        
                        // Re-initialize event listeners
                        document.addEventListener('DOMContentLoaded', loadHabits);
                        loadHabits();
                        
                        // Ensure theme is applied correctly when returning to main screen
                        applyTheme();
                    }, 1000);
                } else {
                    alert('Please fill out all fields');
                }
            };
            
            buttonRow.appendChild(cancelButton);
            buttonRow.appendChild(saveButton);
            
            saveButtonContainer.appendChild(buttonRow);
            
            // Assemble the screen
            appScreen.appendChild(appBar);
            appScreen.appendChild(formContainer);
            appScreen.appendChild(saveButtonContainer);
            
            document.body.appendChild(appScreen);
            
            // Focus the first input for better UX
            nameInput.focus();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadHabits();
            applyTheme();
        });
    </script>
</body>
</html>